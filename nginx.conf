events {
    worker_connections 1024;
}

http {
    upstream ledger_cluster {
        # 只向 Leader 節點轉發寫操作
        server ledger-node1:8080 weight=3;
        server ledger-node2:8080 weight=1 backup;
        server ledger-node3:8080 weight=1 backup;
    }

    upstream ledger_readonly {
        # 讀操作可以分散到所有節點
        server ledger-node1:8080;
        server ledger-node2:8080;
        server ledger-node3:8080;
    }

    server {
        listen 80;
        server_name localhost;

        # API 文檔頁面
        location / {
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>JRaft Ledger Cluster</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .endpoint { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .method { font-weight: bold; color: #0066cc; }
    </style>
</head>
<body>
    <h1>JRaft 分散式帳本系統</h1>
    <h2>API 端點</h2>
    
    <div class="endpoint">
        <span class="method">GET</span> /api/ledger/status - 查詢集群狀態
    </div>
    
    <div class="endpoint">
        <span class="method">GET</span> /api/ledger/accounts - 查詢所有帳戶
    </div>
    
    <div class="endpoint">
        <span class="method">GET</span> /api/ledger/accounts/{accountNumber} - 查詢特定帳戶
    </div>
    
    <div class="endpoint">
        <span class="method">POST</span> /api/ledger/accounts - 創建新帳戶
    </div>
    
    <div class="endpoint">
        <span class="method">POST</span> /api/ledger/transfer - 執行轉帳
    </div>
    
    <div class="endpoint">
        <span class="method">POST</span> /api/ledger/batch-transfer - 批量轉帳
    </div>
    
    <h2>節點狀態</h2>
    <ul>
        <li><a href="/node1/api/ledger/status">節點 1 (8080)</a></li>
        <li><a href="/node2/api/ledger/status">節點 2 (8082)</a></li>
        <li><a href="/node3/api/ledger/status">節點 3 (8084)</a></li>
    </ul>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # 寫操作路由到主節點
        location ~ ^/api/ledger/(transfer|batch-transfer|accounts)$ {
            if ($request_method = POST) {
                proxy_pass http://ledger_cluster;
                break;
            }
            proxy_pass http://ledger_readonly;
        }

        # 讀操作可以路由到任何節點
        location ~ ^/api/ledger/ {
            proxy_pass http://ledger_readonly;
        }

        # 直接訪問特定節點
        location /node1/ {
            proxy_pass http://ledger-node1:8080/;
        }

        location /node2/ {
            proxy_pass http://ledger-node2:8080/;
        }

        location /node3/ {
            proxy_pass http://ledger-node3:8080/;
        }

        # 健康檢查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
} 